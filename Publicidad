/* Comando /publicidad */
var lang = User.getProperty("language") || "en";

var messages = {
    es: {
        notRegistered: "‚ö†Ô∏è Primero debes registrarte usando /register.",
        noAdLink: "‚è≥ Actualmente no hay enlaces de publicidad disponibles. ¬°Vuelve m√°s tarde!",
        adIntro: "üéâ ¬°Atenci√≥n! Tienes una nueva oportunidad de ganar puntos.\n\nüëÄ Abre el enlace y gana 50 puntos.\n\nüîó Pulsa 'Visitar Publicidad' y espera mientras confirmamos tu visita. ¬°Tu apoyo es fundamental! üçÄ",
        confirmAd: "‚úÖ Confirmar visita",
        backToMenu: "üîô Volver al Men√∫",
        visitAd: "üöÄ Visitar Publicidad",
        limitReached: "‚è≥ Has alcanzado el l√≠mite de 10 anuncios. Espera 2 horas antes de ver m√°s anuncios."
    },
    en: {
        notRegistered: "‚ö†Ô∏è First, you must register using /register.",
        noAdLink: "‚è≥ There are no advertisement links available at the moment. Check back later!",
        adIntro: "üéâ Attention! You have a new chance to earn points.\n\nüëÄ Open the link and earn 50 points!\n\nüîó Click 'Visit Ad' and wait while we confirm your visit. Your support is essential! üçÄ",
        confirmAd: "‚úÖ Confirm visit",
        backToMenu: "üîô Back to Menu",
        visitAd: "üöÄ Visit Ad",
        limitReached: "‚è≥ You have reached the limit of 10 ads. Wait 2 hours before viewing more ads."
    },
    ru: {
        notRegistered: "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –ø–æ–º–æ—â—å—é /register.",
        noAdLink: "‚è≥ –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Å—Å—ã–ª–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!",
        adIntro: "üéâ –í–Ω–∏–º–∞–Ω–∏–µ! –£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–∫–∏.\n\nüëÄ –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å 50 –æ—á–∫–æ–≤.\n\nüîó –ù–∞–∂–º–∏—Ç–µ '–ü–æ—Å–µ—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É' –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –º—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–º –≤–∞—à –≤–∏–∑–∏—Ç. –í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∞–∂–Ω–∞! üçÄ",
        confirmAd: "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ",
        backToMenu: "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é",
        visitAd: "üöÄ –ü–æ—Å–µ—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É",
        limitReached: "‚è≥ –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ 10 –æ–±—ä—è–≤–ª–µ–Ω–∏–π. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2 —á–∞—Å–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è."
    },
    hi: {
        notRegistered: "‚ö†Ô∏è ‡§∏‡§¨‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§Ü‡§™‡§ï‡•ã /register ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§",
        noAdLink: "‚è≥ ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§ï‡•ã‡§à ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§≤‡§ø‡§Ç‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç!",
        adIntro: "üéâ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç! ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§Ö‡§Ç‡§ï ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§Æ‡•å‡§ï‡§æ ‡§π‡•à‡•§\n\nüëÄ ‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§™ 50 ‡§Ö‡§Ç‡§ï ‡§§‡§ï ‡§ú‡•Ä‡§§ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç!\n\nüîó '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç' ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨‡§ï‡§ø ‡§π‡§Æ ‡§Ü‡§™‡§ï‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à! üçÄ",
        confirmAd: "‚úÖ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç",
        backToMenu: "üîô ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç",
        visitAd: "üöÄ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç",
        limitReached: "‚è≥ ‡§Ü‡§™‡§®‡•á 10 ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ä‡§Æ‡§æ ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö ‡§ö‡•Å‡§ï‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡•á‡§ñ‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á 2 ‡§ò‡§Ç‡§ü‡•á ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§"
    },
    zh: {
        notRegistered: "‚ö†Ô∏è È¶ñÂÖàÔºåÊÇ®ÂøÖÈ°ª‰ΩøÁî® /register ËøõË°åÊ≥®ÂÜå„ÄÇ",
        noAdLink: "‚è≥ ÂΩìÂâçÊ≤°ÊúâÂèØÁî®ÁöÑÂπøÂëäÈìæÊé•ÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ",
        adIntro: "üéâ Ê≥®ÊÑèÔºÅÊÇ®ÊúâÊñ∞ÁöÑÊú∫‰ºöËµöÂèñÁßØÂàÜ„ÄÇ\n\nüëÄ ÊâìÂºÄÈìæÊé•ÔºåÊÇ®ÂèØËÉΩËµ¢Âæó 50 ÁßØÂàÜÔºÅ\n\nüîó ÁÇπÂáª 'ËÆøÈóÆÂπøÂëä' Âπ∂Á≠âÂæÖÊàë‰ª¨Á°ÆËÆ§ÊÇ®ÁöÑËÆøÈóÆ„ÄÇÊÇ®ÁöÑÊîØÊåÅËá≥ÂÖ≥ÈáçË¶ÅÔºÅüçÄ",
        confirmAd: "‚úÖ Á°ÆËÆ§ËÆøÈóÆ",
        backToMenu: "üîô ËøîÂõûËèúÂçï",
        visitAd: "üöÄ ËÆøÈóÆÂπøÂëä",
        limitReached: "‚è≥ ÊÇ®Â∑≤ËææÂà∞10‰∏™ÂπøÂëäÁöÑËßÇÁúãÈôêÂà∂„ÄÇËØ∑Á≠âÂæÖ2Â∞èÊó∂ÂêéÂÜçÊü•ÁúãÊõ¥Â§öÂπøÂëä„ÄÇ"
    },
    ja: {
        notRegistered: "‚ö†Ô∏è „Åæ„Åö„ÄÅ/register „Çí‰ΩøÁî®„Åó„Å¶ÁôªÈå≤„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
        noAdLink: "‚è≥ ÁèæÂú®„ÄÅÂà©Áî®ÂèØËÉΩ„Å™Â∫ÉÂëä„É™„É≥„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂæå„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
        adIntro: "üéâ Ê≥®ÊÑèÔºÅ„Éù„Ç§„É≥„Éà„ÇíÁç≤Âæó„Åô„ÇãÊñ∞„Åü„Å™„ÉÅ„É£„É≥„Çπ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nüëÄ „É™„É≥„ÇØ„ÇíÈñã„Åè„Å®„ÄÅÊúÄÂ§ß50„Éù„Ç§„É≥„ÉàÁç≤Âæó„Åß„Åç„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„ÇìÔºÅ\n\nüîó „ÄåÂ∫ÉÂëä„ÇíË¶ã„Çã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅË®™Âïè„ÇíÁ¢∫Ë™ç„Åô„Çã„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ„ÅÇ„Å™„Åü„ÅÆ„Çµ„Éù„Éº„Éà„ÅåÈáçË¶Å„Åß„ÅôÔºÅüçÄ",
        confirmAd: "‚úÖ Ë®™Âïè„ÇíÁ¢∫Ë™ç",
        backToMenu: "üîô „É°„Éã„É•„Éº„Å´Êàª„Çã",
        visitAd: "üöÄ Â∫ÉÂëä„ÇíË¶ã„Çã",
        limitReached: "‚è≥ 10‰ª∂„ÅÆÂ∫ÉÂëä„ÅÆ‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åï„Çâ„Å´Â∫ÉÂëä„ÇíË¶ã„Çã„Å´„ÅØ2ÊôÇÈñì„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ"
    },
    ar: {
        notRegistered: "‚ö†Ô∏è ÿ£ŸàŸÑÿßŸãÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ /register.",
        noAdLink: "‚è≥ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±Ÿàÿßÿ®ÿ∑ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä. ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã!",
        adIntro: "üéâ ÿßŸÜÿ™ÿ®ÿßŸá! ŸÑÿØŸäŸÉ ŸÅÿ±ÿµÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÉÿ≥ÿ® ÿßŸÑŸÜŸÇÿßÿ∑.\n\nüëÄ ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸàŸÇÿØ ÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ±ÿ®ÿ≠ 50 ŸÜŸÇÿ∑ÿ©!\n\nüîó ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ 'ÿ≤Ÿäÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ' ŸàÿßŸÜÿ™ÿ∏ÿ± ÿ®ŸäŸÜŸÖÿß ŸÜÿ§ŸÉÿØ ÿ≤Ÿäÿßÿ±ÿ™ŸÉ. ÿØÿπŸÖŸÉ ŸÖŸáŸÖ ŸÑŸÑÿ∫ÿßŸäÿ©! üçÄ",
        confirmAd: "‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©",
        backToMenu: "üîô ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
        visitAd: "üöÄ ÿ≤Ÿäÿßÿ±ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ",
        limitReached: "‚è≥ ŸÑŸÇÿØ ŸàÿµŸÑÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÖŸÜ 10 ÿ•ÿπŸÑÿßŸÜÿßÿ™. ÿßŸÜÿ™ÿ∏ÿ± ÿ≥ÿßÿπÿ™ŸäŸÜ ŸÇÿ®ŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™."
    }
};

// Verificar si el usuario est√° registrado
var userData = Bot.getProperty("user_" + user.telegramid);
if (!userData) {
    Bot.sendMessage(messages[lang].notRegistered);
    return;
}

// Obtener el contador de anuncios y el inicio del per√≠odo de 2 horas
var adCount = User.getProperty("ad_count") || 0;
var adPeriodStart = User.getProperty("ad_period_start") || 0;
var currentTime = new Date().getTime();

// Si han pasado 2 horas desde el inicio del per√≠odo, reiniciar contador
if (!adPeriodStart || currentTime - adPeriodStart >= 7200000) {
    adCount = 0;
    adPeriodStart = currentTime;
    User.setProperty("ad_count", adCount, "integer");
    User.setProperty("ad_period_start", adPeriodStart, "number");
}

// Verificar si el usuario ha alcanzado el l√≠mite
if (adCount >= 10) {
    var remainingTime = 7200000 - (currentTime - adPeriodStart);
    var minutes = Math.floor(remainingTime / 60000);
    var seconds = Math.floor((remainingTime % 60000) / 1000);
    var messageText = messages[lang].limitReached + "\n\n‚è≥ Remaining Time: " + minutes + " min " + seconds + " sec.";

    var backButton = [[{ title: messages[lang].backToMenu, command: "/start" }]];
    Bot.sendInlineKeyboard(backButton, messageText);
    return;
}

// Obtener lista de enlaces de publicidad
var adLinks = Bot.getProperty("ad_links") || [];
if (!Array.isArray(adLinks) || adLinks.length === 0) {
    Bot.sendMessage(messages[lang].noAdLink);
    return;
}

// Seleccionar un enlace aleatorio
var adLink = adLinks[Math.floor(Math.random() * adLinks.length)];

// Incrementar contador y guardar
adCount++;
User.setProperty("ad_count", adCount, "integer");

// Configurar visita
User.setProperty("ad_in_progress", true, "boolean");
User.setProperty("ad_time", currentTime, "number");

// Crear teclado inline
var keyboard = [
    [{ title: messages[lang].visitAd, url: adLink }],
    [{ title: messages[lang].backToMenu, command: "/start" }]
];

Bot.sendInlineKeyboard(keyboard, messages[lang].adIntro);

// Evitar m√∫ltiples ejecuciones de confirmaci√≥n
if (!User.getProperty("ad_confirm_scheduled")) {
    User.setProperty("ad_confirm_scheduled", true, "boolean");
    Bot.run({ command: "/confirmpublicidad", run_after: 12 });
    Bot.run({ command: "/resetConfirmFlag", run_after: 15 });
}
