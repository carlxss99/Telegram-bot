// /visitlink
var lang = User.getProperty("language") || "en"; // Obtener el idioma del usuario, predeterminado a inglÃ©s

// FunciÃ³n para generar mensajes dinÃ¡micos
function getMessage(key) {
  var messages = {
    es: {
      notRegistered: "âš ï¸ Primero debes registrarte usando /register.",
      noLinksAvailable: "âŒ No hay enlaces disponibles para visitar en este momento.",
      invite: "ðŸ“¢ Â¡Invita a tus amigos para que compartan mÃ¡s enlaces!",
      selectedLink: "ðŸ”— Se ha seleccionado el bot: ",
      visitPrompt: "ðŸ‘€ Pulsa 'Visitar enlace' para abrirlo y espera la confirmaciÃ³n.",
      backToMenu: "â¬…ï¸ Volver al MenÃº",
      visitConfirmed: "âœ… Â¡Visita confirmada con Ã©xito!",
      visitButton: "Visitar enlace"
    },
    en: {
      notRegistered: "âš ï¸ First, you must register using /register.",
      noLinksAvailable: "âŒ There are no available links to visit at the moment.",
      invite: "ðŸ“¢ Invite your friends so they can share more links!",
      selectedLink: "ðŸ”— The selected bot is: ",
      visitPrompt: "ðŸ‘€ Click 'Visit link' to open it and wait for confirmation.",
      backToMenu: "â¬…ï¸ Back to Menu",
      visitConfirmed: "âœ… Visit successfully confirmed!",
      visitButton: "Visit link"
    },
    ru: {
      notRegistered: "âš ï¸ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐ¹Ñ‚ÐµÑÑŒ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ /register.",
      noLinksAvailable: "âŒ Ð’ Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑÑÑ‹Ð»Ð¾Ðº Ð´Ð»Ñ Ð¿Ð¾ÑÐµÑ‰ÐµÐ½Ð¸Ñ.",
      invite: "ðŸ“¢ ÐŸÑ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚Ðµ ÑÐ²Ð¾Ð¸Ñ… Ð´Ñ€ÑƒÐ·ÐµÐ¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¼Ð¾Ð³Ð»Ð¸ Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ ÑÑÑ‹Ð»ÐºÐ°Ð¼Ð¸!",
      selectedLink: "ðŸ”— Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð±Ð¾Ñ‚: ",
      visitPrompt: "ðŸ‘€ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'ÐŸÐ¾ÑÐµÑ‚Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ', Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐµÑ‘ Ð¸ Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.",
      backToMenu: "â¬…ï¸ Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð² Ð¼ÐµÐ½ÑŽ",
      visitConfirmed: "âœ… ÐŸÐ¾ÑÐµÑ‰ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¾!",
      visitButton: "ÐŸÐ¾ÑÐµÑ‚Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ"
    },
    hi: { // Hindi
      notRegistered: "âš ï¸ à¤ªà¤¹à¤²à¥‡ à¤†à¤ªà¤•à¥‹ /register à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤•à¥‡ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤•à¤°à¤¨à¤¾ à¤¹à¥‹à¤—à¤¾à¥¤",
      noLinksAvailable: "âŒ à¤‡à¤¸ à¤¸à¤®à¤¯ à¤¦à¥‡à¤–à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤•à¥‹à¤ˆ à¤²à¤¿à¤‚à¤• à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¤‚à¥¤",
      invite: "ðŸ“¢ à¤…à¤ªà¤¨à¥‡ à¤¦à¥‹à¤¸à¥à¤¤à¥‹à¤‚ à¤•à¥‹ à¤†à¤®à¤‚à¤¤à¥à¤°à¤¿à¤¤ à¤•à¤°à¥‡à¤‚ à¤¤à¤¾à¤•à¤¿ à¤µà¥‡ à¤…à¤§à¤¿à¤• à¤²à¤¿à¤‚à¤• à¤¸à¤¾à¤à¤¾ à¤•à¤° à¤¸à¤•à¥‡à¤‚!",
      selectedLink: "ðŸ”— à¤šà¤¯à¤¨à¤¿à¤¤ à¤¬à¥‰à¤Ÿ à¤¹à¥ˆ: ",
      visitPrompt: "ðŸ‘€ à¤²à¤¿à¤‚à¤• à¤–à¥‹à¤²à¤¨à¥‡ à¤”à¤° à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¥€ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ 'à¤²à¤¿à¤‚à¤• à¤ªà¤° à¤œà¤¾à¤à¤‚' à¤ªà¤° à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¥‡à¤‚à¥¤",
      backToMenu: "â¬…ï¸ à¤®à¥‡à¤¨à¥‚ à¤ªà¤° à¤µà¤¾à¤ªà¤¸ à¤œà¤¾à¤à¤‚",
      visitConfirmed: "âœ… à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¥€ à¤—à¤ˆ!",
      visitButton: "à¤²à¤¿à¤‚à¤• à¤ªà¤° à¤œà¤¾à¤à¤‚"
    },
    zh: { // Chino simplificado
      notRegistered: "âš ï¸ ä½ å¿…é¡»å…ˆä½¿ç”¨ /register è¿›è¡Œæ³¨å†Œã€‚",
      noLinksAvailable: "âŒ ç›®å‰æ²¡æœ‰å¯è®¿é—®çš„é“¾æŽ¥ã€‚",
      invite: "ðŸ“¢ é‚€è¯·ä½ çš„æœ‹å‹åˆ†äº«æ›´å¤šé“¾æŽ¥ï¼",
      selectedLink: "ðŸ”— é€‰å®šçš„æœºå™¨äººæ˜¯: ",
      visitPrompt: "ðŸ‘€ ç‚¹å‡» 'è®¿é—®é“¾æŽ¥' æ‰“å¼€å¹¶ç­‰å¾…ç¡®è®¤ã€‚",
      backToMenu: "â¬…ï¸ è¿”å›žèœå•",
      visitConfirmed: "âœ… è®¿é—®æˆåŠŸç¡®è®¤ï¼",
      visitButton: "è®¿é—®é“¾æŽ¥"
    },
    ja: { // JaponÃ©s
      notRegistered: "âš ï¸ ã¾ãš /register ã‚’ä½¿ç”¨ã—ã¦ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
      noLinksAvailable: "âŒ ç¾åœ¨è¨ªå•ã§ãã‚‹ãƒªãƒ³ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
      invite: "ðŸ“¢ å‹é”ã‚’æ‹›å¾…ã—ã¦ã€ã‚ˆã‚Šå¤šãã®ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ï¼",
      selectedLink: "ðŸ”— é¸æŠžã•ã‚ŒãŸãƒœãƒƒãƒˆ: ",
      visitPrompt: "ðŸ‘€ ã€Œãƒªãƒ³ã‚¯ã‚’è¨ªå•ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ãã€ç¢ºèªã‚’å¾…ã£ã¦ãã ã•ã„ã€‚",
      backToMenu: "â¬…ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹",
      visitConfirmed: "âœ… è¨ªå•ãŒæ­£å¸¸ã«ç¢ºèªã•ã‚Œã¾ã—ãŸï¼",
      visitButton: "ãƒªãƒ³ã‚¯ã‚’è¨ªå•"
    },
    ar: { // Ãrabe
      notRegistered: "âš ï¸ Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /register.",
      noLinksAvailable: "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…ØªØ§Ø­Ø© Ù„Ù„Ø²ÙŠØ§Ø±Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.",
      invite: "ðŸ“¢ Ø¯Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙŠØ´Ø§Ø±ÙƒÙˆÙ† Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!",
      selectedLink: "ðŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‡Ùˆ: ",
      visitPrompt: "ðŸ‘€ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ 'Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø·' Ù„ÙØªØ­Ù‡ ÙˆØ§Ù†ØªØ¸Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯.",
      backToMenu: "â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
      visitConfirmed: "âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!",
      visitButton: "Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø·"
    }
  };

  return messages[lang][key] || messages["es"][key]; // Fallback a espaÃ±ol
}

var userData = Bot.getProperty("user_" + user.telegramid);
if (!userData) {
  Bot.sendMessage(getMessage("notRegistered"));
  return;
}

// Obtener todos los usuarios que han agregado enlaces
var allUsers = Bot.getProperty("all_users", []);
if (allUsers.length === 0) {
  Bot.sendMessage(getMessage("noLinksAvailable") + "\n\n" + getMessage("invite"));
  return;
}

var availableLinks = [];
allUsers.forEach(function(uid) {
  if (uid !== user.telegramid) {
    var data = Bot.getProperty("user_" + uid);
    if (data && data.links && data.links.length > 0) { // Validar que data.links existe
      availableLinks = availableLinks.concat(data.links.map(link => ({ id: uid, username: data.username, link: link })));
    }
  }
});

if (availableLinks.length === 0) {
  Bot.sendMessage(getMessage("noLinksAvailable") + "\n\n" + getMessage("invite"));
  return;
}

// Seleccionar un enlace aleatorio de los enlaces disponibles
var selected = availableLinks[Math.floor(Math.random() * availableLinks.length)];

// Extraer el nombre del bot desde el enlace
function getBotName(url) {
  var match = url.match(/t\.me\/([^?]+)/);
  return match ? match[1] : "desconocido";
}

var botName = getBotName(selected.link);

// Guardar datos de la visita
User.setProperty("visit_target", selected.id, "string");
User.setProperty("visit_username", selected.username, "string");
User.setProperty("visit_link", selected.link, "string");
User.setProperty("visit_time", new Date().getTime(), "number"); // Guardar el tiempo de visita
User.setProperty("visit_in_progress", true, "boolean");

// Crear teclado inline
var keyboard = [
  [{ title: getMessage("visitButton"), url: selected.link }],  
  [{ title: getMessage("backToMenu"), command: "/cancelvisit" }]
];

Bot.sendInlineKeyboard(
  keyboard,
  "ðŸŽ¯ " + getMessage("invite") + "\n\n" +
  getMessage("selectedLink") + "âœ¨ *" + botName + "* âœ¨\n\n" +
  getMessage("visitPrompt")  
);

// Confirmar la visita automÃ¡ticamente despuÃ©s de un tiempo (10 segundos en este caso)
Bot.run({ command: "/confirmvisit", run_after: 10 });
