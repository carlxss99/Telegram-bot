// Mensajes para el sistema de referidos con formato simplificado y traducci√≥n completa
var messages = {
  es: {
    introduction: "üéâ ¬°Bienvenido al sistema de referidos! Comparte tu enlace y gana puntos.",
    referralLink: "üîó Tu enlace de referido es: ",
    pointsGained: "‚úÖ Has ganado {points} puntos.",
    totalReferrals: "üë• Has referido a {count} usuarios.",
    activeReferrals: "üî• Activos: {active} | ‚è≥ Inactivos: {inactive}",
    referralRank: "üèÜ Rango: {rank}",
    backToMenu: "Volver al men√∫",
    backText: "üîô Volver al men√∫ principal.",
    rankBeginner: "ü•â Principiante",
    rankIntermediate: "ü•à Intermedio",
    rankExpert: "ü•á Experto",
    errorGeneratingLink: "‚ö†Ô∏è Hubo un error al generar el enlace. Intenta de nuevo m√°s tarde.",
    notRegistered: "‚ö†Ô∏è Primero necesitas registrarte."
  },
  en: {
    introduction: "üéâ Welcome to the referral system! Share your link and earn points.",
    referralLink: "üîó Your referral link is: ",
    pointsGained: "‚úÖ You have earned {points} points.",
    totalReferrals: "üë• You have referred {count} users.",
    activeReferrals: "üî• Active: {active} | ‚è≥ Inactive: {inactive}",
    referralRank: "üèÜ Rank: {rank}",
    backToMenu: "Back to menu",
    backText: "üîô Back to the main menu.",
    rankBeginner: "ü•â Beginner",
    rankIntermediate: "ü•à Intermediate",
    rankExpert: "ü•á Expert",
    errorGeneratingLink: "‚ö†Ô∏è There was an error generating the link. Please try again later.",
    notRegistered: "‚ö†Ô∏è You need to register first."
  },
  ru: {
    introduction: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–æ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—á–∫–∏.",
    referralLink: "üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: ",
    pointsGained: "‚úÖ –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ {points} –æ—á–∫–æ–≤.",
    totalReferrals: "üë• –í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
    activeReferrals: "üî• –ê–∫—Ç–∏–≤–Ω—ã–µ: {active} | ‚è≥ –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ: {inactive}",
    referralRank: "üèÜ –†–∞–Ω–≥: {rank}",
    backToMenu: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é",
    backText: "üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
    rankBeginner: "ü•â –ù–∞—á–∏–Ω–∞—é—â–∏–π",
    rankIntermediate: "ü•à –°—Ä–µ–¥–Ω–∏–π",
    rankExpert: "ü•á –≠–∫—Å–ø–µ—Ä—Ç",
    errorGeneratingLink: "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
    notRegistered: "‚ö†Ô∏è –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è."
  },
  hi: {
    introduction: "üéâ ‡§∞‡•á‡§´‡§∞‡§≤ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! ‡§Ö‡§™‡§®‡§æ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§Ç‡§ï ‡§ï‡§Æ‡§æ‡§è‡§Ç‡•§",
    referralLink: "üîó ‡§Ü‡§™‡§ï‡§æ ‡§∞‡•á‡§´‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§π‡•à: ",
    pointsGained: "‚úÖ ‡§Ü‡§™‡§®‡•á {points} ‡§Ö‡§Ç‡§ï ‡§ï‡§Æ‡§æ‡§è ‡§π‡•à‡§Ç‡•§",
    totalReferrals: "üë• ‡§Ü‡§™‡§®‡•á {count} ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§∞‡•á‡§´‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§",
    activeReferrals: "üî• ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø: {active} | ‚è≥ ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø: {inactive}",
    referralRank: "üèÜ ‡§∞‡•à‡§Ç‡§ï: {rank}",
    backToMenu: "‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å",
    backText: "üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å‡•§",
    rankBeginner: "ü•â ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä",
    rankIntermediate: "ü•à ‡§Æ‡§ß‡•ç‡§Ø‡§µ‡§∞‡•ç‡§§‡•Ä",
    rankExpert: "ü•á ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û",
    errorGeneratingLink: "‚ö†Ô∏è ‡§≤‡§ø‡§Ç‡§ï ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®: ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§",
    notRegistered: "‚ö†Ô∏è ‡§™‡§π‡§≤‡•á ‡§Ü‡§™‡§ï‡•ã ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§"
  },
  zh: {
    introduction: "üéâ Ê¨¢Ëøé‰ΩøÁî®Êé®ËçêÁ≥ªÁªüÔºÅÂàÜ‰∫´ÊÇ®ÁöÑÈìæÊé•Âπ∂ËµöÂèñÁßØÂàÜ„ÄÇ",
    referralLink: "üîó ÊÇ®ÁöÑÊé®ËçêÈìæÊé•ÊòØÔºö",
    pointsGained: "‚úÖ ÊÇ®Â∑≤Ëé∑Âæó {points} ÂàÜ„ÄÇ",
    totalReferrals: "üë• ÊÇ®Â∑≤ÈÇÄËØ∑ {count} ‰ΩçÁî®Êà∑„ÄÇ",
    activeReferrals: "üî• Ê¥ªË∑É: {active} | ‚è≥ ‰∏çÊ¥ªË∑É: {inactive}",
    referralRank: "üèÜ ÊéíÂêç: {rank}",
    backToMenu: "ËøîÂõûËèúÂçï",
    backText: "üîô ËøîÂõû‰∏ªËèúÂçï„ÄÇ",
    rankBeginner: "ü•â ÂàùÁ∫ß",
    rankIntermediate: "ü•à ‰∏≠Á∫ß",
    rankExpert: "ü•á È´òÁ∫ß",
    errorGeneratingLink: "‚ö†Ô∏è ÁîüÊàêÈìæÊé•Êó∂Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
    notRegistered: "‚ö†Ô∏è ÊÇ®ÈúÄË¶ÅÂÖàÊ≥®ÂÜå„ÄÇ"
  },
  ja: {
    introduction: "üéâ Á¥π‰ªã„Ç∑„Çπ„ÉÜ„É†„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ„É™„É≥„ÇØ„ÇíÂÖ±Êúâ„Åó„Å¶„Éù„Ç§„É≥„Éà„ÇíÁç≤Âæó„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
    referralLink: "üîó „ÅÇ„Å™„Åü„ÅÆÁ¥π‰ªã„É™„É≥„ÇØ: ",
    pointsGained: "‚úÖ {points} „Éù„Ç§„É≥„Éà„ÇíÁç≤Âæó„Åó„Åæ„Åó„Åü„ÄÇ",
    totalReferrals: "üë• „ÅÇ„Å™„Åü„ÅåÁ¥π‰ªã„Åó„Åü„É¶„Éº„Ç∂„ÉºÊï∞: {count}",
    activeReferrals: "üî• „Ç¢„ÇØ„ÉÜ„Ç£„Éñ: {active} | ‚è≥ Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: {inactive}",
    referralRank: "üèÜ „É©„É≥„ÇØ: {rank}",
    backToMenu: "„É°„Éã„É•„Éº„Å´Êàª„Çã",
    backText: "üîô „É°„Éã„É•„Éº„Å´Êàª„Çã„ÄÇ",
    rankBeginner: "ü•â ÂàùÂøÉËÄÖ",
    rankIntermediate: "ü•à ‰∏≠Á¥ö",
    rankExpert: "ü•á ‰∏äÁ¥ö",
    errorGeneratingLink: "‚ö†Ô∏è „É™„É≥„ÇØ„ÅÆÁîüÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂæå„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
    notRegistered: "‚ö†Ô∏è „Åæ„ÅöÁôªÈå≤„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
  },
  ar: {
    introduction: "üéâ ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ ŸÅŸä ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©! ÿ¥ÿßÿ±ŸÉ ÿ±ÿßÿ®ÿ∑ŸÉ ŸàÿßŸÉÿ≥ÿ® ŸÜŸÇÿßÿ∑.",
    referralLink: "üîó ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸáŸà: ",
    pointsGained: "‚úÖ ŸÑŸÇÿØ ÿ±ÿ®ÿ≠ÿ™ {points} ŸÜŸÇÿßÿ∑.",
    totalReferrals: "üë• ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ•ŸÑŸâ {count} ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.",
    activeReferrals: "üî• ŸÜÿ¥ÿ∑: {active} | ‚è≥ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑: {inactive}",
    referralRank: "üèÜ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®: {rank}",
    backToMenu: "ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
    backText: "üîô ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.",
    rankBeginner: "ü•â ŸÖÿ®ÿ™ÿØÿ¶",
    rankIntermediate: "ü•à ŸÖÿ™Ÿàÿ≥ÿ∑",
    rankExpert: "ü•á ÿÆÿ®Ÿäÿ±",
    errorGeneratingLink: "‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ±ÿßÿ®ÿ∑. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇŸãÿß.",
    notRegistered: "‚ö†Ô∏è Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ£ŸàŸÑÿßŸã."
  }
};

// Obtener el idioma del usuario (por defecto, ingl√©s)
var lang = (User.getProperty("language") || "en").toLowerCase();
if (!messages[lang]) { lang = "en"; }

// Obtener datos del usuario
var userData = Bot.getProperty("user_" + user.telegramid);

if (userData) {
  Bot.sendMessage(messages[lang].introduction);

  // Generar el enlace de referido (aseg√∫rate de usar el username correcto de tu bot)
  var referralLink = Libs.ReferralLib.currentUser.getRefLink("Refferalassistantbot");

  // Verificar si se gener√≥ correctamente el enlace
  if (!referralLink) {
    var errorButton = [[{ title: messages[lang].backToMenu, command: "/start" }]];
    Bot.sendInlineKeyboard(errorButton, messages[lang].errorGeneratingLink);
    return;
  }

  // Datos del usuario
  var totalReferrals = Math.max(0, userData.referrals || 0); // Evita valores negativos
  var activeReferrals = Math.max(0, userData.activeReferrals || 0);
  var inactiveReferrals = Math.max(0, totalReferrals - activeReferrals);

  // Determinar el rango seg√∫n los referidos
  var rank = totalReferrals >= 50 ? messages[lang].rankExpert : totalReferrals >= 20 ? messages[lang].rankIntermediate : messages[lang].rankBeginner;

  // Mensaje unificado para mejorar la eficiencia del bot
  var message = messages[lang].referralLink + "<a href='" + referralLink + "'>" + referralLink + "</a>\n\n" +
                messages[lang].totalReferrals.replace("{count}", totalReferrals) + "\n" +
                messages[lang].activeReferrals.replace("{active}", activeReferrals).replace("{inactive}", inactiveReferrals) + "\n" +
                messages[lang].referralRank.replace("{rank}", rank);

  Bot.sendMessage(message, { parse_mode: "HTML" });

  // Bot√≥n para volver al men√∫
  var backButton = [[{ title: messages[lang].backToMenu, command: "/start" }]];
  Bot.sendInlineKeyboard(backButton, messages[lang].backText);

} else {
  Bot.sendMessage(messages[lang].notRegistered);
}
