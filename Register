// ğŸ“Œ /register - Registro del usuario y manejo de referidos
var lang = User.getProperty("language") || "en";

// Mensajes en diferentes idiomas
var messages = {
  es: {
    alreadyRegistered: "âš ï¸ Ya estÃ¡s registrado.",
    registrationSuccess: "âœ… Registro exitoso.\nSi algo no funciona bien, usa /reRegister para intentarlo nuevamente.",
    registrationFailed: "âŒ El registro no ha funcionado correctamente. Usa el comando /reRegister para intentar nuevamente.",
    nextAction: "ğŸ¤” Â¿QuÃ© te gustarÃ­a hacer a continuaciÃ³n?",
    referrerPoints: "ğŸ‰ Â¡Tu referidor ha ganado {points} puntos!",
    referredSuccess: "ğŸ‰ Â¡Te has registrado con Ã©xito a travÃ©s de un referidor!",
    retryRegistration: "ğŸ”„ Reintentar registro"
  },
  en: {
    alreadyRegistered: "âš ï¸ You are already registered.",
    registrationSuccess: "âœ… Registration successful.\nIf something is not working properly, use /reRegister to try again.",
    registrationFailed: "âŒ Registration did not work properly. Use the /reRegister command to try again.",
    nextAction: "ğŸ¤” What would you like to do next?",
    referrerPoints: "ğŸ‰ Your referrer has earned {points} points!",
    referredSuccess: "ğŸ‰ You have successfully registered through a referrer!",
    retryRegistration: "ğŸ”„ Try registering again"
  },
  ru: {
    alreadyRegistered: "âš ï¸ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹.",
    registrationSuccess: "âœ… Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾.\nĞ•ÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /reRegister Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸.",
    registrationFailed: "âŒ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /reRegister Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸.",
    nextAction: "ğŸ¤” Ğ§Ñ‚Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚ĞµĞ»Ğ¸ Ğ±Ñ‹ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ?",
    referrerPoints: "ğŸ‰ Ğ’Ğ°Ñˆ Ñ€ĞµÑ„ĞµÑ€ĞµÑ€ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» {points} Ğ¾Ñ‡ĞºĞ¾Ğ²!",
    referredSuccess: "ğŸ‰ Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ÑÑŒ Ñ‡ĞµÑ€ĞµĞ· Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°!",
    retryRegistration: "ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ"
  },
  hi: {
    alreadyRegistered: "âš ï¸ à¤†à¤ª à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤¹à¥€ à¤ªà¤‚à¤œà¥€à¤•à¥ƒà¤¤ à¤¹à¥ˆà¤‚à¥¤",
    registrationSuccess: "âœ… à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤¸à¤«à¤² à¤°à¤¹à¤¾à¥¤\nà¤¯à¤¦à¤¿ à¤•à¥à¤› à¤ à¥€à¤• à¤¸à¥‡ à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥ˆ, à¤¤à¥‹ /reRegister à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤•à¥‡ à¤ªà¥à¤¨: à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    registrationFailed: "âŒ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤¸à¤«à¤² à¤¨à¤¹à¥€à¤‚ à¤¹à¥à¤†à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ /reRegister à¤•à¤®à¤¾à¤‚à¤¡ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤•à¥‡ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    nextAction: "ğŸ¤” à¤†à¤—à¥‡ à¤†à¤ª à¤•à¥à¤¯à¤¾ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¥‡à¤‚à¤—à¥‡?",
    referrerPoints: "ğŸ‰ à¤†à¤ªà¤•à¥‡ à¤°à¥‡à¤«à¤°à¤° à¤¨à¥‡ {points} à¤…à¤‚à¤• à¤•à¤®à¤¾à¤ à¤¹à¥ˆà¤‚!",
    referredSuccess: "ğŸ‰ à¤†à¤ª à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤°à¥‡à¤«à¤°à¤² à¤•à¥‡ à¤®à¤¾à¤§à¥à¤¯à¤® à¤¸à¥‡ à¤ªà¤‚à¤œà¥€à¤•à¥ƒà¤¤ à¤¹à¥‹ à¤—à¤ à¤¹à¥ˆà¤‚!",
    retryRegistration: "ğŸ”„ à¤ªà¥à¤¨à¤ƒ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤•à¤°à¥‡à¤‚"
  },
  zh: {
    alreadyRegistered: "âš ï¸ ä½ å·²ç»æ³¨å†Œè¿‡äº†ã€‚",
    registrationSuccess: "âœ… æ³¨å†ŒæˆåŠŸã€‚\nå¦‚æœå‡ºç°é—®é¢˜ï¼Œè¯·ä½¿ç”¨ /reRegister å†è¯•ä¸€æ¬¡ã€‚",
    registrationFailed: "âŒ æ³¨å†Œå¤±è´¥ã€‚è¯·ä½¿ç”¨ /reRegister å‘½ä»¤é‡è¯•ã€‚",
    nextAction: "ğŸ¤” æ¥ä¸‹æ¥ä½ æƒ³åšä»€ä¹ˆï¼Ÿ",
    referrerPoints: "ğŸ‰ ä½ çš„æ¨èäººè·å¾—äº† {points} åˆ†ï¼",
    referredSuccess: "ğŸ‰ ä½ å·²æˆåŠŸé€šè¿‡æ¨èäººæ³¨å†Œï¼",
    retryRegistration: "ğŸ”„ é‡è¯•æ³¨å†Œ"
  },
  ja: {
    alreadyRegistered: "âš ï¸ ã‚ãªãŸã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚",
    registrationSuccess: "âœ… ç™»éŒ²ãŒæˆåŠŸã—ã¾ã—ãŸã€‚\nä½•ã‹å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€/reRegister ã‚’ä½¿ã£ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
    registrationFailed: "âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚/reRegister ã‚³ãƒãƒ³ãƒ‰ã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
    nextAction: "ğŸ¤” æ¬¡ã«ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ",
    referrerPoints: "ğŸ‰ ã‚ãªãŸã®ç´¹ä»‹è€…ã¯ {points} ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ãŸï¼",
    referredSuccess: "ğŸ‰ ç´¹ä»‹çµŒç”±ã§æ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼",
    retryRegistration: "ğŸ”„ å†ç™»éŒ²ã™ã‚‹"
  },
  ar: {
    alreadyRegistered: "âš ï¸ Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.",
    registrationSuccess: "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.\nØ¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… /reRegister Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
    registrationFailed: "âŒ ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù…Ø± /reRegister Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
    nextAction: "ğŸ¤” Ù…Ø§Ø°Ø§ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡ Ø¨Ø¹Ø¯ Ø°Ù„ÙƒØŸ",
    referrerPoints: "ğŸ‰ Ù„Ù‚Ø¯ Ø­ØµÙ„ Ø§Ù„Ù…Ø­ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¹Ù„Ù‰ {points} Ù†Ù‚Ø§Ø·!",
    referredSuccess: "ğŸ‰ ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­ÙŠÙ„!",
    retryRegistration: "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
  }
};

// ğŸ“Œ Obtener datos del usuario
var userData = Bot.getProperty("user_" + user.telegramid);

// FunciÃ³n para manejar registro
function registerUser() {
  var username = user.username ? "@" + user.username : "Usuario_" + user.telegramid;
  var newUser = { username: username, points: 0, referrals: 0, links: [] };

  // Guardar usuario
  Bot.setProperty("user_" + user.telegramid, newUser, "json");

  // Manejo de referidos usando ReferralLib
  Libs.ReferralLib.currentUser.track({
    onAttractedByUser: function (refUser) {
      // Sumar puntos al referidor y contar el referido (sin usar bandera para evitar duplicados)
      var referrerData = Bot.getProperty("user_" + refUser.chatId);
      if (referrerData) {
        referrerData.points += 50;
        referrerData.referrals += 1;
        Bot.setProperty("user_" + refUser.chatId, referrerData, "json");
        Bot.sendMessage(messages[lang].referrerPoints.replace("{points}", 50));
      }
      Bot.sendMessage(messages[lang].referredSuccess);
    }
  });

  // Enviar mensaje de registro exitoso con opciÃ³n para reintentar
  var retryKeyboard = [
    [{ title: messages[lang].retryRegistration, command: "/reRegister" }]
  ];
  Bot.sendInlineKeyboard(retryKeyboard, messages[lang].registrationSuccess);
}

// Si el usuario ya estÃ¡ registrado, enviamos un mensaje adecuado
if (userData) {
  Bot.sendMessage(messages[lang].alreadyRegistered);
} else {
  registerUser();
}

// ğŸ›  Teclado inline con opciones
var langButtons = {
  es: "â• Agregar Enlace",
  ru: "â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ",
  hi: "â• à¤²à¤¿à¤‚à¤• à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
  zh: "â• æ·»åŠ é“¾æ¥",
  ja: "â• ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ",
  ar: "â• Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·",
  en: "â• Add Link"
};
var rankingButtons = {
  es: "ğŸ† Ver Ranking",
  ru: "ğŸ† ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³",
  hi: "ğŸ† à¤°à¥ˆà¤‚à¤•à¤¿à¤‚à¤— à¤¦à¥‡à¤–à¥‡à¤‚",
  zh: "ğŸ† æŸ¥çœ‹æ’å",
  ja: "ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹",
  ar: "ğŸ† Ø¹Ø±Ø¶ Ø§Ù„ØªØµÙ†ÙŠÙ",
  en: "ğŸ† View Ranking"
};
var pointsButtons = {
  es: "ğŸ’ Mis Puntos",
  ru: "ğŸ’ ĞœĞ¾Ğ¸ ĞÑ‡ĞºĞ¸",
  hi: "ğŸ’ à¤®à¥‡à¤°à¥‡ à¤…à¤‚à¤•",
  zh: "ğŸ’ æˆ‘çš„ç§¯åˆ†",
  ja: "ğŸ’ ç§ã®ãƒã‚¤ãƒ³ãƒˆ",
  ar: "ğŸ’ Ù†Ù‚Ø§Ø·ÙŠ",
  en: "ğŸ’ My Points"
};
var backToMenuButton = {
  es: "ğŸ”™ Volver al MenÃº",
  ru: "ğŸ”™ Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ¼ĞµĞ½Ñ",
  hi: "ğŸ”™ à¤®à¥‡à¤¨à¥‚ à¤ªà¤° à¤µà¤¾à¤ªà¤¸ à¤œà¤¾à¤à¤‚",
  zh: "ğŸ”™ è¿”å›èœå•",
  ja: "ğŸ”™ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹",
  ar: "ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
  en: "ğŸ”™ Back to Menu"
};

var keyboard = [
  [{ title: langButtons[lang], command: "/addlink" }],
  [{ title: rankingButtons[lang], command: "/rankings" }],
  [{ title: pointsButtons[lang], command: "/checkpoints" }],
  [{ title: backToMenuButton[lang], command: "/start" }]
];

Bot.sendInlineKeyboard(keyboard, messages[lang].nextAction);
